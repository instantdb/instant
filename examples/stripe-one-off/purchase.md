# Purchase Flow

## User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Home Page                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  [Buy Full Pack â€” $5]               â”‚                       â”‚
â”‚  â”‚                                     â”‚                       â”‚
â”‚  â”‚  ğŸ”’ ğŸ”’ ğŸ”’  (blurred wallpapers)     â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â”‚                                           â”‚
â”‚                     â–¼                                           â”‚
â”‚            1. Click "Buy"                                       â”‚
â”‚            2. Token saved to localStorage                       â”‚
â”‚                     â”‚                                           â”‚
â”‚                     â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚         Stripe Checkout             â”‚                       â”‚
â”‚  â”‚    [Enter card details + Pay]       â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â”‚                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚         â–¼                      â–¼                                â”‚
â”‚     Success                 Cancel                              â”‚
â”‚         â”‚                      â”‚                                â”‚
â”‚         â–¼                      â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Success Page â”‚    â”‚  Home Page   â”‚                          â”‚
â”‚  â”‚              â”‚    â”‚  (can retry) â”‚                          â”‚
â”‚  â”‚ âœ“ Unlocked!  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚  â”‚ ğŸ–¼ ğŸ–¼ ğŸ–¼      â”‚                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Payment Flow

```
Client                      Stripe                      Server
  â”‚                           â”‚                           â”‚
  â”‚ 1. Generate token         â”‚                           â”‚
  â”‚    Save to localStorage   â”‚                           â”‚
  â”‚                           â”‚                           â”‚
  â”‚ 2. POST /api/checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
  â”‚                           â”‚                           â”‚
  â”‚    â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ checkout URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                           â”‚                           â”‚
  â”‚ 3. Redirect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
  â”‚                           â”‚                           â”‚
  â”‚                     4. User pays                      â”‚
  â”‚                           â”‚                           â”‚
  â”‚                           â”‚ 5. Webhook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                           â”‚    (with token)           â”‚
  â”‚                           â”‚                           â”‚ 6. Create
  â”‚                           â”‚                           â”‚    purchase
  â”‚                           â”‚                           â”‚
  â”‚    â—€â”€â”€ 7. Redirect â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
  â”‚        to /success        â”‚                           â”‚
  â”‚                           â”‚                           â”‚
  â”‚ 8. Query wallpapers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
  â”‚    with token             â”‚                           â”‚
  â”‚                           â”‚                           â”‚
  â”‚    â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ fullResUrl returned â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                           â”‚                           â”‚
  â–¼                           â–¼                           â–¼
```

## Data Model

```
purchases                          wallpapers
â”œâ”€â”€ token (proves ownership)       â”œâ”€â”€ name
â”œâ”€â”€ email                          â”œâ”€â”€ thumbnailUrl (public)
â”œâ”€â”€ stripeSessionId          â—€â”€â”€â”€â”€â–¶â”œâ”€â”€ fullResUrl (protected)
â”œâ”€â”€ status                         â””â”€â”€ order
â””â”€â”€ createdAt
        â””â”€â”€â”€â”€â”€â”€ many-to-many â”€â”€â”€â”€â”€â”€â”˜
```

## Access Control

```ts
// Permission rule for wallpapers.fullResUrl
"ruleParams.token in data.ref('purchases.token')"
```

- Query includes valid token â†’ `fullResUrl` returned â†’ wallpaper unlocked
- Query has no token or invalid token â†’ `fullResUrl` omitted â†’ wallpaper locked

## Recovery Flow

```
/recover
   â”‚
   â–¼
Enter email
   â”‚
   â–¼
Receive magic code (via InstantDB)
   â”‚
   â–¼
Enter code â†’ Authenticated
   â”‚
   â–¼
Query purchases by email
   â”‚
   â–¼
Save token to localStorage â†’ Done
```
