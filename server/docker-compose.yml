services:
  web:
    image: IMAGE_REPLACE_ME
    environment:
      - BEANSTALK_PORT=80
      - PRODUCTION=true
      # Internal load balancer
      - HONEYCOMB_ENDPOINT=http://refinery.us-east-1.elasticbeanstalk.com:8082
    env_file:
      - .env
      # Generated by .platform/hooks/prebuild/prebuild.sh
      - hazelcast.env
      - java.env
    network_mode: "host"
    stop_grace_period: 2m
    restart: on-failure
    cap_add:
      - CAP_PERFMON
      - CAP_IPC_LOCK
      - CAP_SYS_ADMIN
    command: sh -c 'java $${EXTRA_JAVA_OPTS} -XX:+UseLargePages -XX:+AlwaysPreTouch -XX:+UseNUMA -Xlog:gc+init,pagesize --add-modules java.se --add-exports java.base/jdk.internal.ref=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.management/sun.management=ALL-UNNAMED --add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED -XX:+UnlockDiagnosticVMOptions -XX:+DebugNonSafepoints -Djdk.attach.allowAttachSelf -Djava.awt.headless=true -Dcom.sun.management.jmxremote.port=10001 -Dcom.sun.management.jmxremote.rmi.port=10001 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -XX:StartFlightRecording=disk=true,maxsize=1G,name=instant,filename=instant_$(date +%s%N).jfr -Dcom.sun.management.jmxremote.local.only=false -Djava.rmi.server.hostname=localhost -Djdk.tracePinnedThreads=full -server -jar target/instant-standalone.jar'
    logging:
      driver: awslogs
      options:
        awslogs-region: us-east-1
        # EB_ENV_NAME will replaced by .platform/hooks/prebuild/prebuild.sh
        awslogs-group: /aws/elasticbeanstalk/EB_ENV_NAME/var/log/eb-docker/containers/eb-current-app/stdouterr.log
        awslogs-create-group: 'true'
